#!/bin/bash

set -o nounset
set -o errexit
set -o pipefail

function rename() {
	local action=${1:-0}
	local file=${2:-}
	if [ -z "${file}" ]
	then
		cat >&2 <<- EOF
			No file argument given
			EOF
		return 1
	fi
	if [ ! -r "${file}" ]
	then
		echo "Cannot read $file" >&2
		return 1
	fi

	filepathname=$(realpath --no-symlinks "${file}")
	filename=$(basename "${filepathname}")
	filepath=$(dirname "${filepathname}")
	filenamebase=${filename%.*}
	filenamext=${filename##*.}
	filepoch=$(stat -c %Y "${filepathname}")
	filets=$(date -d @${filepoch} +%Y%m%d%H%M%S)
	if [ "${action}" -eq 1 ]
	then
		newpathname="${filepath}/${filets}-${filenamebase}.${filenamext}"
	elif [ "${action}" -eq 2 ]
	then
		newpathname="${filepath}/${filets}.${filenamext}"
	else
		cat >&2 <<- EOF
			Non-act action given, in rename function. Don't know what to do.
			EOF
			return 1
	fi

	$DEBUG mv --verbose "${filepathname}" "${newpathname}"
}

action="${1:-}"
if [ -z "${action}" ]
then
	cat >&2 <<- EOF
		No file argument given

		$(basename $0) [optional action: 0 or 1] filenames..

			option 0:  don't act, just show what would happen
				   01   action 1 by default (or option 01)
				   02   for action 2, issue option 02
					   this is also the default when action is omitted
		    option 1 : prepend a timestamp to the current filename timestamp-filename.ext
		    option 2 : just rename the file to timestamp.ext

		EOF
    exit 1
fi

DEBUG="echo"
if [ "${action}" = 1 ] || [ "${action}" = 2 ]
then
	action="$1"
	files=("${@:2}")
	DEBUG=""
elif [ "${action}" = 0 ] || [ "${action}" = 01 ]
then
	DEBUG="echo"
	action=1
	files=("${@:2}")
elif [ "${action}" = 02 ]
then
	DEBUG="echo"
	action=2
	files=("${@:2}")
else
	DEBUG="echo"
	action=1
	files=($@)
fi

for file in "${files[@]}"
do
	rename "${action}" "${file}"
done

