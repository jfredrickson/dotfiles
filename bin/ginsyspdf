#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"
check_debug_logging

SOURCE="$1"
TITLE="$2"
SUBTITLE="$3"

MAKETITLEPDF=titlepdf

if [ ! -x $(which pdftk) ]
	then
		echo "pdftk not installed"
	fi

if [ -z "$SOURCE" ]
        then
                echo "Usage: $0 source \"title\" \"subtitle\" - if source does not end in (pdf|PDF) only a title page is created."
                exit
        fi


DOCUMENTSDIR=~/Templates

FRONTPAGETEMPLATE=$DOCUMENTSDIR/GinsysFrontpageOverlay.pdf
BODYTEMPLATE=$DOCUMENTSDIR/GinsysBodyOverlay.pdf

TITLEPAGE=$DOCUMENTSDIR/TitlePage.pdf
GINSYSTITLEPAGE=$DOCUMENTSDIR/GinsysTitlePage.pdf

BASESOURCE=$(basename $SOURCE)
OUTPUT=Ginsys-$(echo "$TITLE-$SUBTITLE" | sed s/\ /\_/g)-$(date +%Y%m%d).pdf

TEMP=/tmp/merged.pdf
TEMP2=/tmp/merged2.pdf

#generate title & subtitle page
$MAKETITLEPDF $TITLEPAGE "$TITLE" "$SUBTITLE"

#overlay source doc with bodytemplate
if [ ${SOURCE##*.} = "pdf" -o ${SOURCE##*.} = "PDF" ]
	then
		pdftk $SOURCE background $BODYTEMPLATE output $TEMP
	else
		TEMP=""
	fi

#overlay title page with frontpagetemplate
pdftk $TITLEPAGE background $FRONTPAGETEMPLATE output $GINSYSTITLEPAGE

#merge title and body
pdftk $GINSYSTITLEPAGE $TEMP cat output $TEMP2

#set pdf meta info and security
cat <<EOF | pdftk $TEMP2 update_info - output $OUTPUT
InfoKey: Title
InfoValue: $TITLE
InfoKey: Subject
InfoValue: $SUBTITLE
InfoKey: Author
InfoValue: Ginsys - Serge van Ginderachter
InfoKey: Keywords
InfoValue: Ginsys, $(date +%Y%m%d), $SOURCE, $TITLE, $SUBTITLE
EOF

#cleanup
if [ ! -n $TEMP ]
	then
		rm $TEMP
	fi
if [ ! -n $TEMP2 ]
	then
		rm $TEMP2
	fi

