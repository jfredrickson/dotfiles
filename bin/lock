#!/bin/bash

# # i3lock on commputer sleep
#   Source: https://bbs.archlinux.org/viewtopic.php?pid=1170536#p1170536 by 65kid
#   Also: https://wiki.debian.org/ScreenLockingOnSleep
#

DEBUG=""
#DEBUG=1
#DEBUG=2
if [ -n "${DEBUG}" ] && [ $DEBUG -gt 1 ]
then
	set -x
fi
LOCKSLEEP=5
TIMEFORMAT='%3R'

set -o nounset
set -o errexit
set -o pipefail

# load some defaults
source "$HOME/etc/defaults"

# log this scripts full output
logfile="${lockscreen_image%.*}.log"
exec &> >(tee "${logfile}")

i3lock_icons="$HOME/Pictures/icons/i3lock"
i3lock_icon="${i3lock_icons}/token.png"
lockscreen="${1:-$default_lockscreen}"

MYUID="$(id -u "${USER}")"
PIDPATH=/var/run/user/${MYUID:-1000}/i3lock
PIDFILE=${PIDPATH}/pid
install -g serge -o serge -m 700 -d "${PIDPATH}"


##############################
## subroutines              ##
##############################

function prepare() {
	echo "Check music players and sound volume. (${SECONDS}s)"

	PLAYERCTLSTATUS="$(playerctl status ||:)"
	ponymix is-muted && MUTED=yes || MUTED=no || :

	echo "Pick the right lockscreen image.(${SECONDS}s)"
	if [ ! "$lockscreen" = "keep" ] && [ ! "$lockscreen" = "blurred" ]
	then
		echo "Choosing a picture background. (${SECONDS}s)"
		setbg lock "$lockscreen"
	elif [ "$lockscreen" = "blurred" ]
	then
		make_blurred
	else
		echo "Keeping the current lockscreen. (${SECONDS}s)"
		return
	fi
	annotate_lockscreen ${lockscreen_image}
}

function make_blurred() {
	# take a screenshot and blur it for the lock screen
	echo "Take a screenshot and blur it. (${SECONDS}s)"
	BLUR="-blur 0x5"
	/usr/bin/maim --format=png --hidecursor --quality 7 --quiet "$screenshot_image"
	convert "$screenshot_image" ${BLUR} "$lockscreen_image"
}

function annotate_lockscreen() {
	echo "Annotate lockscreen with lock symbol and optional text. (${SECONDS}s)"
	TEXT=""

	local image
	image="${1:-$lockscreen}"
	ICON="${i3lock_icon}"
	# for some reason "convert -list font" returns 1
	FONT="$( (convert -list font ||:) | awk "{ a[NR] = \$2 } /family: $(fc-match sans -f "%{family}\n")/ { print a[NR-1]; exit }")"

	LOCK=()
	while read LINE
	do
		if [[ "$LINE" =~ ([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+) ]]; then
			W=${BASH_REMATCH[1]}
			H=${BASH_REMATCH[2]}
			Xoff=${BASH_REMATCH[3]}
			Yoff=${BASH_REMATCH[4]}
			MIDXi=$((W / 2 + Xoff - 60  / 2))
			MIDYi=$((H / 2 + Yoff - 60  / 2))
			MIDXt=$((W / 2 + Xoff - 285 / 2))
			MIDYt=$((H / 2 + Yoff + 320 / 2))
			LOCK+=(-font $FONT -pointsize 26 -fill lightgrey -stroke grey10 \
				   -strokewidth 2 -annotate +$MIDXt+$MIDYt "$TEXT" \
				   -fill lightgrey -stroke lightgrey -strokewidth 1 -annotate +$MIDXt+$MIDYt "$TEXT" \
				   $ICON -geometry +$MIDXi+$MIDYi -composite)
		fi
	done <<<"$(xrandr)"
	convert "$image" "${LOCK[@]}" "$image"
}

function pre_lock() {
	if [ "${PLAYERCTLSTATUS}" = "Playing" ]
	then
		echo "Stop any music player. (${SECONDS}s)"
		playerctl stop || echo "Could not stop the music player. (${SECONDS}s)" >&2
	fi
	if [ "${MUTED}" = "no" ]
	then
		echo "Mute sound. (${SECONDS}s)"
		ponymix mute >/dev/null || echo "Could not mute the sound. (${SECONDS}s)" >&2
	fi

	echo "Disable presentation mode. (${SECONDS}s)"
	presentation-mode stop

    # sleep because seems too soon after pres mode stop
	(
		echo "Pause notifications. (${SECONDS}s)"
		sleep 1
		killall -v -SIGUSR1 dunst
	 ) &

	echo "Lock remote irssi screen. (${SECONDS}s)"
	irc lock || :
}

function perform_lock() {
	# start the real lock command in the background, set the PID file,
	# then wait for the lock to end (when unlocked)
	if [ -z "${DEBUG}" ]
	then
		echo "Running i3lock. (${SECONDS}s)"
        i3lock --show-failed-attempts --tiling --nofork --ignore-empty-password --image ~/.lockscreen.png &
	else
		echo "Now is when we would run i3lock, sleeping for ${LOCKSLEEP}s."
		sleep ${LOCKSLEEP} &
	fi

	# get and set i3lock pid
	local PID=$!
	setpid $PID

	# give i3lock a bit of time to display the image
	sleep 1

	## /etc/systemd/system/i3lock.service
	#
	# [Unit]
	# Description=i3lock
	# Before=sleep.target
	#
	# [Service]
	# User=serge
	# Type=notify
	# NotifyAccess=all
	# Environment=DISPLAY=:0.0
	# ExecStart=/home/serge/bin/lock
	# PIDFile=/var/run/user/1000/i3lock/pid
	#
	# [Install]
	# WantedBy=sleep.target
	#
	systemd-notify --ready --status="Screen locked with image $lockscreen" &>/dev/null && \
		echo "Notifying systemd the lock is done. (${SECONDS}s)" || :

	wait
}

function post_lock() {

	echo "Unlock remote irssi screen. (${SECONDS}s)"
	irc unlock || :

    echo "Re-enable notifications. (${SECONDS}s)"
    killall -v -SIGUSR2 dunst

	# re-renable music if it was playing
	if [ "${PLAYERCTLSTATUS}" = "Playing" ]
	then
		echo "Restart music player. (${SECONDS}s)"
		playerctl play || echo "Could not start the music player." >&2
	fi
	if [ "${MUTED}" = "no" ]
	then
		echo "Unmute the sounds again. (${SECONDS}s)"
		ponymix unmute >/dev/null || echo "Could not unmute the sound." >&2
	fi

	delpid
}

function setpid() {
	PID=${1:-$$}
	echo $PID >"${PIDFILE}"
	echo "Lock process started with pid $PID, set in ${PIDFILE}. (${SECONDS}s)"
}

function delpid() {
	rm -fv "${PIDFILE}"
}

function main() {
	# prepare lock screen image
	prepare

	# prepare system before locking
	pre_lock

    # lock screen with a lock screen image picture
	perform_lock

	# post lock to be run after screen is unlocked
	post_lock
	}

date +%Y.%m.%d-%H:%M
main

