#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

pulseaudio --check || pulseaudio --start


function outputs() {
	outputs=$(pactl list short sinks | awk '{print $1}' |
				grep -v ^$ | sort -n | xargs)
	current_sink=$(defaultsink)
	# make the current default sink the first in the list, whilst keeping tyhe
	# list circular sorted
	echo "${current_sink} ${outputs#*${current_sink}} ${outputs%${current_sink}*}"
}

function outputsnames() {
	for sink in $(outputs)
	do
		echo "$sink $(sinkname $sink)"
	done
}

function defaultsink() {
	ponymix defaults | grep sink | awk '{print $2}' | sed 's/://'
}

function sinkname() {
	local sinknum=${1:-0}
	pactl list sinks | grep -A3 "#${sinknum}$" | grep Description | cut -d: -f 2- | xargs
}

function selectsink() {
	outputsnames | (dmenu -p "Select audio output: " -l 10 ||:) | awk '{print $1}'
}

function updatesink() {
	local next_sink=$1
	pacmd set-default-sink $next_sink
	pactl list short sink-inputs | awk '{print $1}' | while read -r streamid
	do
		pactl move-sink-input "$streamid" "$next_sink"
	done
}

function main() {
	local action=${1:-}

	# reset pulseaudio-dlna-d to let him clean up old dlna devices
	#pkill -SIGINT --parent $(pgrep --full "bin/pulseaudio-dlna-d" | head -n 1)

	previous_sink=$(defaultsink)
	previous_sink_name=$(sinkname $previous_sink)

	if [ "${action}" = "builtin" ]
	then
		next_sink="$(pa-default builtin)"
		next_sink_name="${PA_SINK_DEFAULT_NAME}"
	else
		next_sink=$(selectsink)
		[ -z "$next_sink" ] && exit
		next_sink_name=$(sinkname $next_sink)
	fi

	if [ ! "${previous_sink}" -eq "${next_sink}" ]
	then
		updatesink $next_sink
		notify_send -u low "Activated: $next_sink_name" "previously: $previous_sink_name"
	fi
}

main ${1:-}
