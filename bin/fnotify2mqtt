#!/bin/bash

on_exit() {
    exit
}

trap on_exit INT TERM KILL EXIT

send_notify() {
    tail -f $HOME/.irssi/fnotify | \
    while read message
    do
        mosquitto_pub -t irssi -q 2 -m "$message"
    done
}

check_message_queue() {
    nc -z localhost 1883
}

while sleep 1
do
    if      check_message_queue
    then
            echo "`date` ### connected"
            send_notify
            echo "`date` ### connection lost"
    else
            sleep 3
    fi
done

