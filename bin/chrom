#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"
check_debug_logging

# based on https://www.uninformativ.de/blog/postings/2016-06-19/0/POSTING-en.html

BROWSER="google-chrome"
SWITCHES=""
PROFILESDIR="$HOME/.config/${BROWSER}/profiles"
CACHEDIR="$HOME/.cache/google-chrome/profiles"

function _cleanup() {
	rm -Rf "${PROFILEPATH}" "${CACHEPATH}"
}

function _set_tmp() {
	PROFILEPATH="$(mktemp -d -p "${PROFILESDIR}")"
	PROFILENAME="${PROFILEPATH#${PROFILESDIR}/}" # get the basename 'tmp-***'
	CLASS="browser-${PROFILENAME}"
	PROFILECLASS="${PROFILENAME}"
	CACHEPATH="${CACHEDIR}/${PROFILENAME}"

	SWITCHES="${SWITCHES} --no-first-run"
	SWITCHES="${SWITCHES} --disable-infobars"
	SWITCHES="${SWITCHES} --disable-translate"
	SWITCHES="${SWITCHES} --window-size=1200,800"
	SWITCHES="${SWITCHES} --incognito"

	_addpreferences
}

function _addpreferences() {
	local=PREFERENCEDIR
	# shellcheck disable=SC2034
	local=PREFERENCEPATH
	PREFERENCEDIR="${PROFILEPATH}/user_data/Default"
	PREFERENCEPATH="${PREFERENCEDIR}/Preferences"

	mkdir -p "${PREFERENCEDIR}"
	cat >"${PREFERENCEPATH}" <<-EOF
			"spellcheck": {
				"dictionaries": [
					"en-US"
				],
				"dictionary": ""
			},
			"translate": {
				"enabled": false
			},
				"translate_blocked_languages": [
					"en",
					"nl",
					"fr"
			],
			"alternate_error_pages": {
				"enabled": false
			},
			"autofill": {
				"enabled": false
			},
			"BROWSER": {
				"show_home_button" : false,
				"check_default_BROWSER" : false
				"custom_chrome_frame": false,
				"enable_spellchecking": false
			},
			"bookmark_bar": {
				"show_apps_shortcut": false,
				"show_on_all_tabs": false
			},
			"download": {
				"directory_upgrade": true,
				"prompt_for_download": true,
				"default_directory": "~/PROFILEPATH"
			},
			"net": {
				"network_prediction_options": 2
			},
			"profile": {
				"password_manager_enabled": false
			},
			"safebrowsing": {
				"enabled": false
			},
			"search": {
				"suggest_enabled": false
			},
			"distribution": {
				"auto_launch_chrome": false,
				"skip_first_run_ui": true,
				"import_bookmarks": true,
				"import_search_engine": false,
				"import_history": false,
				"import_home_page": true,
				"create_all_shortcuts": false,
				"do_not_launch_chrome": true,
				"make_chrome_default": false
				"make_chrome_default_for_user": false,
				"suppress_first_run_bubble": true,
				"do_not_create_desktop_shortcut": true,
				"do_not_create_quick_launch_shortcut": true,
				"do_not_launch_chrome": true,
				"do_not_register_for_update_launch": true,
				"suppress_first_run_default_BROWSER_prompt": true,
				"show_welcome_page": false,
				"skip_first_run_ui": true,
				"suppress_first_run_bubble": true,
				"system_level": true,
				"verbose_logging": true
			  },
			"sync_promo": {
				"show_on_first_run_allowed": false
			}
		}
		EOF
}

function _query_parameter() {
	local QUERY=""
	for p in $*
	do
		if [ -z "${QUERY}" ]
		then
			QUERY="${p}"
		else
			QUERY="${QUERY}+${p}"
		fi
	done
	echo ${QUERY}
}



mkdir -p "${PROFILESDIR}" "${CACHEDIR}"
myname=$(basename $0)
case ${myname} in
	i|g)
		PROFILECLASS=${myname}
		;;
	*)
		if [ -n "${1:-}" ]
		then
			PROFILECLASS="${1}"
		else
			PROFILECLASS="tmp"
		fi
		;;
esac

CLASS=browser-${PROFILECLASS}
PROFILEPATH=${PROFILESDIR}/${PROFILECLASS}
case ${PROFILECLASS} in
	serge*)				shift;;
	facebook*)			shift;;
	radio)				shift;;
	bryxx)				shift;;
	g)	# google search
		[ $PROFILECLASS != $myname ] && shift
		URL="https://www.google.com/search?q"
		QUERY=$(_query_parameter $*)
		shift $#
		_set_tmp
		SWITCHES="${SWITCHES} ${URL}=${QUERY}"
		;;
	i)	# google image search
		[ $PROFILECLASS != $myname ] && shift
		URL="https://www.google.com/search?as_st=y&tbs=isz%3Alt%2Cislt%3A2mp&tbm=isch&source=hp&biw=1920&bih=973&ei=k1VfWu2jKYjKkwXJorDoDQ&q"
		QUERY=$(_query_parameter $*)
		shift $#
		_set_tmp
		SWITCHES="${SWITCHES} ${URL}=${QUERY}"
		;;
	*)
		_set_tmp
		trap _cleanup EXIT
		;;
esac



ARGS=("$@")

if [ -n "${CLASS}" ]
then
	SWITCHES="--class=${CLASS} ${SWITCHES}"
fi

if [ -n "${PROFILEPATH}" ]
then
	SWITCHES="--user-data-dir=${PROFILEPATH} ${SWITCHES}"
fi

# shellcheck disable=SC2068
echo /usr/bin/${BROWSER} ${SWITCHES} ${ARGS[@]}
# shellcheck disable=SC2068
/usr/bin/${BROWSER} ${SWITCHES} "${ARGS[@]}"

