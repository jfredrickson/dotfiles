#!/bin/bash
# based on https://www.uninformativ.de/blog/postings/2016-06-19/0/POSTING-en.html

set -o nounset
set -o errexit
set -o pipefail


BROWSER="google-chrome"
SWITCHES=""
PROFILESDIR="$HOME/.config/${BROWSER}/profiles"
CACHEDIR="$HOME/.cache/google-chrome/profiles"

function _cleanup() {
	rm -Rf "${PROFILEPATH}" "${CACHEPATH}"
}

function _addpreferences() {
	local=PREFERENCEDIR
	# shellcheck disable=SC2034
	local=PREFERENCEPATH
	PREFERENCEDIR="${PROFILEPATH}/user_data/Default"
	PREFERENCEPATH="${PREFERENCEDIR}/Preferences"

	mkdir -p "${PREFERENCEDIR}"
	cat >"${PREFERENCEPATH}" <<-EOF
			"spellcheck": {
				"dictionaries": [
					"en-US"
				],
				"dictionary": ""
			},
			"translate": {
				"enabled": false
			},
				"translate_blocked_languages": [
					"en",
					"nl",
					"fr"
			],
			"alternate_error_pages": {
				"enabled": false
			},
			"autofill": {
				"enabled": false
			},
			"BROWSER": {
				"show_home_button" : false,
				"check_default_BROWSER" : false
				"custom_chrome_frame": false,
				"enable_spellchecking": false
			},
			"bookmark_bar": {
				"show_apps_shortcut": false,
				"show_on_all_tabs": false
			},
			"download": {
				"directory_upgrade": true,
				"prompt_for_download": true,
				"default_directory": "~/PROFILEPATH"
			},
			"net": {
				"network_prediction_options": 2
			},
			"profile": {
				"password_manager_enabled": false
			},
			"safebrowsing": {
				"enabled": false
			},
			"search": {
				"suggest_enabled": false
			},
			"distribution": {
				"auto_launch_chrome": false,
				"skip_first_run_ui": true,
				"import_bookmarks": true,
				"import_search_engine": false,
				"import_history": false,
				"import_home_page": true,
				"create_all_shortcuts": false,
				"do_not_launch_chrome": true,
				"make_chrome_default": false
				"make_chrome_default_for_user": false,
				"suppress_first_run_bubble": true,
				"do_not_create_desktop_shortcut": true,
				"do_not_create_quick_launch_shortcut": true,
				"do_not_launch_chrome": true,
				"do_not_register_for_update_launch": true,
				"suppress_first_run_default_BROWSER_prompt": true,
				"show_welcome_page": false,
				"skip_first_run_ui": true,
				"suppress_first_run_bubble": true,
				"system_level": true,
				"verbose_logging": true
			  },
			"sync_promo": {
				"show_on_first_run_allowed": false
			}
		}
		EOF
}

mkdir -p "${PROFILESDIR}" "${CACHEDIR}"
if [ -n "${1:-}" ]
then
	PROFILECLASS="${1}"
else
	PROFILECLASS="tmp"
fi

case ${PROFILECLASS} in
	serge*|facebook|radio|bryxx)
		CLASS=browser-${PROFILECLASS}
		PROFILEPATH=${PROFILESDIR}/${PROFILECLASS}
		shift
		;;
	*)
		PROFILEPATH="$(mktemp -d -p "${PROFILESDIR}")"
		PROFILENAME="${PROFILEPATH#${PROFILESDIR}/}" # get the basename 'tmp-***'
		CLASS="browser-${PROFILENAME}"
		PROFILECLASS="${PROFILENAME}"
		CACHEPATH="${CACHEDIR}/${PROFILENAME}"

		SWITCHES="${SWITCHES} --no-first-run"
		SWITCHES="${SWITCHES} --disable-infobars"
		SWITCHES="${SWITCHES} --disable-translate"
		SWITCHES="${SWITCHES} --window-size=1200,800"
		SWITCHES="${SWITCHES} --incognito"

		_addpreferences
		trap _cleanup EXIT
		;;
esac



ARGS=("$@")

if [ -n "${CLASS}" ]
then
	SWITCHES="${SWITCHES} --class=${CLASS}"
fi

if [ -n "${PROFILEPATH}" ]
then
	SWITCHES="${SWITCHES} --user-data-dir=${PROFILEPATH}"
fi

# shellcheck disable=SC2068
echo /usr/bin/${BROWSER} ${SWITCHES} ${ARGS[@]}
# shellcheck disable=SC2068
/usr/bin/${BROWSER} ${SWITCHES} ${ARGS[@]}

