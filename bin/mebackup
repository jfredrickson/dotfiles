#!/bin/bash

exec >> /var/log/mebackup.log 2>&1
echo "== start "; date

if test -b /dev/disk/by-uuid/e9804409-4dda-490d-b837-419611929a69
then
    device=acdbackup
elif test -b /dev/disk/by-uuid/227503c6-1b37-4c70-b469-8d580c034ef6
then
    device=homebackup
else
    exit 1
fi

sudo mkdir -p /media/serge/datasafe
sudo cryptdisks_start $device && \
sudo mount /dev/mapper/$device /media/serge/datasafe

sleep 2
sudo rsnapshot ${1:-daily}

sudo umount /dev/mapper/$device && \
    sleep 5 && \
    sudo fsck -p /dev/mapper/$device

sleep 2
sudo cryptdisks_stop $device

sudo rmdir /media/serge/datasafe || exit 1

