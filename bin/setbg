#! /bin/bash -e

# File locations
tmp=/tmp/filelist.log
defaultbg=$HOME/.background.png
pictures=Pictures/Backgrounds
target=${1}
action=${2}

# cd out of the way to avoid expansion of regexp
cd $HOME/tmp


if [ "${action}" = "linkpng" ]
then
    _search="-iregex .*.png"
else
    _search="-iregex .*.jpg -o -iregex .*.png"
fi

# if target given but not readeable, assume subdir of
if [ ! -z "${target}" -a ! -r "${target}" ]
then
    if [ -r "$HOME/${pictures}/${target}" ]
    then
        target="$HOME/${pictures}/${target}"
    elif [ -r "$HOME/${target}" ]
    then
        target="$HOME/${target}"
    else
        exit 1
    fi
fi

# if empty, just confirm default
if [ -z "${target}" ]
then
    background=${defaultbg}
# else if directory
elif [ -d "${target}" ]
then
    pictures="${target}"
    # Create a temporary logfile of all matches
    find -L ${pictures} $_search > ${tmp}

    # Choose a random line number (any number from 1 to the length of the file)
    LowerBound=1
    RandomMax=32767
    UpperBound=$(cat ${tmp} | wc -l)
    RandomLine=$(( $LowerBound + ($UpperBound * $RANDOM) / ($RandomMax + 1) ))

    # Use sed to grab the random line
    background=$(sed -n "$RandomLine{p;q;}" "${tmp}")
elif [ -r "${target}" ]
then
    background="${target}"
else
    exit 1
fi

echo ${background}
if [ "${action}" != "link" -a  "${action}" != "linkpng" ]
then
    [ ! "${background}" = "${defaultbg}" ] && (
        background=`readlink -e "${background}"`
        ln -nfs "${background}" "${defaultbg}")
    feh --no-fehbg --bg-fill ${defaultbg}
fi
