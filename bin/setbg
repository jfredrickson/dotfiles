#!/bin/bash

## Parameters

#tmp=/tmp/background-file-list.setbg
setbg_delay=1800

# load some defaults
. $HOME/etc/defaults

p1="$1"
p2="$2"


## Functions

error() {
    echo "$*" >&2
    exit 1
}

checkcli() {
    # check cli parameters
    if [ -z "$p1" ]     # zero parameters
    then
        action='default'
        target="${defaultbg}"
    elif [ ! -z "$p2" ] # two parameters
    then
        action="$p1"
        target="$p2"
    else                # only one parameter
        case "$p1" in
            ## keep this in sync with options in main loop
            lock|redisplay|default)
                action="$p1"
                if [ ! -z "$p2" ] # two parameters
                then
                    target="${p2}"
                else
                    target="${defaultbg}"
                fi
                ;;
            *)
                action='default'
                target="$p1"
                ;;
        esac
    fi
}

checktarget() {
    ## check target
    deeptarget=$(find $HOME/${pictures} -maxdepth 3 -name $(basename ${target}) -o -wholename ${target} -type d | sort | head -n 1 )

    if [ -r "${deeptarget}" ]
        then target="${deeptarget}"
    elif [ -r "${target}" ]
        then :
    elif [ -r "$HOME/${target}" ]
        then target="$HOME/${target}"
    elif [ -r "$HOME/${pictures}/${target}" ]
        then target="$HOME/${pictures}/${target}"
    else
        error "Cannot find a target \"${target}\""
    fi
}

pickpic() {
    # get picture according to target
    # target is set to a file/dir we can read
    if [ -d "${target}" ]
    then # if directory, the pick a random picture
        pictures="${target}"

        # disable shell expansion for the iregex
        set -o noglob
        # Pick random picture
        background="`find -L ${pictures} -type f -iregex .*.jpg -o -iregex .*.png | sort -R | head -n 1`"
        #find -L ${pictures} -iregex .*.jpg -o -iregex .*.png | sort -R > ${tmp}
        # reenable shell expansion
        set +o noglob

    else # a file, should be a picture
        background="${target}"
    fi
    background=`readlink -e "${background}"`
}

definebg() {
    # set as default background
    ln -nfs "${background}" "${defaultbg}"
}

displaybg() {
    # set the background
    feh --no-fehbg --bg-fill ${defaultbg}
}

createlockpic() {
    # create a picture fill-resized to the primary screen for the lockscreen
    disp_res=`xrandr | grep primary | awk '{print $4}' | sed s/\+.*//g`
    convert "${background}" -resize ${disp_res}^ \
                            -gravity center \
                            -extent ${disp_res} \
                            "${lockscreen_image}"
}

trap_loop() {
    loop
}

loop() {
    while true
    do
        # press ctrl-c to change wallpaper, or twice to exit
        trap SIGINT
        sleep 0.5
        setbg
        trap trap_loop SIGINT
        sleep ${setbg_delay}
    done
}

showpath() {
    # show which picture is used
    echo -e "`date +%Y%m%d.%H%M%S`\t`readlink --canonicalize ${background}`"
}

setbg() {
    checktarget
    pickpic
    definebg
    displaybg
    showpath
}

lock() {
    checktarget
    pickpic
    createlockpic
    showpath
}

main() {
    # what parameters did we get?
    checkcli
    case ${action} in
        ## keep this in sync with options in checkcli
        'lock')
            lock
            ;;
        'redisplay') # just redisplay bg, adjusts new screen sizes
            displaybg
            ;;
        'default')  # default action, pick and set a background
            setbg
            ;;
        'loop')
            loop
            ;;
        *)
            error "Unknown action \"${action}\""
            ;;
    esac
}

cd ~
main

