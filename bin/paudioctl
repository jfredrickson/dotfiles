#!/bin/bash


## check for pulseaudio
if [ -x "`which pacmd`" -a -x "`which pactl`" ]
then
    :
else
    echo 'Could not detect Pulseaudio.' >&2
    exit 1
fi

## parameters #####

command=$1
sink=$2
available_sinks=`pacmd list-sinks | grep -e name: -e index: \
                    | sed s/[\<\>]//g | awk -F: '{ print $2}'`
input_sinks=`pacmd list-sink-inputs | grep index | awk '{ print $2 }'`


## functions ######

check_sink_name() {
    echo "$available_sinks" | grep $sink >/dev/null
    if [ ! $? -eq 0 ]
    then
        echo Could not find sink \"$sink\"
        echo
        exit 1
    fi
}

set_default_sink_name() {
    case $HOSTNAME in
       "goldorak")
           sink="alsa_output.pci-0000_00_1b.0.analog-stereo"
           ;;
       "cyberlab")
           sink="alsa_output.pci-0000_00_1b.0.analog-surround-51"
           ;;
       *)
           sink="0"
           ;;
    esac
}

set_sink() {
    # move all sink-inputs automatically
    echo "$input_sinks" | while read line
    do
        [ -z "$line" ] && break
        input=`echo $line`
        pactl move-sink-input $input $sink
    done
}



## main loop ######

# check given command & parameter
if [ -z "$command" ]
then
    echo "`basename $0` toggle|min|plus|use [sink]" >&2
    echo
    exit 1
fi

if [ -z "$sink" ]
then
    set_default_sink_name
else
    check_sink_name
fi


# allways set the default sink
pactl set-default-sink $sink

# act on command
case $command in
    toggle)
        pactl set-sink-mute $sink toggle
        ;;
    min)
        pactl set-sink-volume $sink -- -2dB
        ;;
    plus)
        pactl set-sink-volume $sink -- +2dB
        ;;
    use)
        set_sink
        ;;
    *)
        echo Unknown command $command >&2
        echo
        exit 1
        ;;
esac

# trigger i3statusbar output if available
killall -SIGUSR1 i3status

