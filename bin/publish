#!/bin/bash

publoc=~/Dropbox/Public

file="${1:-`xclip -out`}"
if [ ! -f "${file}" ]
then	echo File  \'${file}\' not found
	exit 1
fi

pubfilename=$(basename "${file}" | sed -r 's/\ +/_/g')
pubfile="${publoc}/${pubfilename}"

cp "${file}" "${pubfile}"
dropbox_puburl="https://dl.dropboxusercontent.com/u/13986042/${pubfilename}"

bitly_url=`bitly $dropbox_puburl | tr -d '\n'`
echo -n $bitly_url | xclip -in -selection clipboard

echo "'${pubfile}' <= ${dropbox_puburl} <= $bitly_url" && (
    while	(dropbox filestatus "${pubfile}" | grep syncing)
    do	sleep 3
    done
    echo
    echo $bitly_url
    notify-send --category=transfer.complete \
                --urgency=low --icon=gtk-info \
                "Dropbox file $file published" \
                "file uploaded $bitly_url"
    ) || echo "Dropbox error"

