#!/bin/bash

session_exists() {
    if (screen -list | grep "\.$name" > /dev/null)
    then    return 0
    else    return 1
    fi
    }

not_empty() {
    if [ ! -z "$*" ]
    then    return 0
    else    return 1
    fi
    }

check_options() {
    if [ -x "`which "$3"`" ]
    then  # command starts at third parameter,
          # first is session name, second a special commandoption
        name="$1"
        shift # name is gone
        cmd="$1"
        shift # cmd is gone
        command="$*"

    elif [ -x "`which "$2"`" ]
    then  # command starts at second parameter, first is session name
        cmd="_start_or_attach"
        name="$1"
        shift # name is gone
        command="$*"

    elif [ -x "`which "$1"`" ]
    then  # command starts at first parameter
        cmd="_start_or_attach"
        name="$1"
        command="$*"

    else # no command, just reattach
        name="$1"
        cmd="_start_or_attach"
    fi
    }

build_screen_options() {
    case $cmd in
        _start_or_attach)
            if session_exists
            then # attach
                echo "attach to screen session $name"
                options="-Rx $name"
                command=""
            else # start new
                if not_empty $command
                then
                    echo "start new screen session $name"
                    options="-S $name -t $name -d -m"
                else # will fail
                    options=""
                fi
            fi
            ;;
        add)
            if not_empty $command
            then
                if session_exists
                then # add new window and command
                    echo "add new command to session $name"
                    options="-S $name -X screen"
                    # avoid race condition with multiple launch commands & starting new
                    sleep 2
                else # start new
                    echo "start new screen session $name"
                    options="-S $name -t $name -d -m"
                fi
            else
                options=""
            fi
            ;;
        *)
            options=""
            command=""
            ;;
    esac
    }

execute_screen() {
    screen $options $command
    }

main() {
    if not_empty $*
    then
        check_options $*
        build_screen_options $*
        if [ ! -z "$options$command" ]
        then
            execute_screen
        else
            echo "no command given"
        fi
    else
        echo "missing session name" >&2
    fi
    screen -list
    }

main $*
