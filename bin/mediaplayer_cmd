#!/bin/bash

mopidy=$(pidof -x mopidy)
nuvola=$(pidof nuvolaplayer)
spotify=$(pidof spotify)
tomahawk=$(pidof tomahawk)
action=$1

# nuvolaplayer gets priority
if [ -z "$mopidy" -a \
     -z "$spotify" -a \
     -z "$tomahawk" -a \
     -z "$nuvola" ]     ; then
    echo "No running mediaplayer found."
elif [ ! -z "$tomahawk" ]; then
    player="tomahawk"
elif [ ! -z "$nuvola" ]; then
    player="nuvola"
elif [ ! -z "$spotify" ]; then
    player="spotify"
elif [ ! -z "$mopidy" ]; then
    player="mopidy"
fi

case "${player}=${action}" in
    # PLAY/TOGGLE
    "mopidy=play")
        ncmpcpp toggle
        ;;
    "spotify=play")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
           /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause
        ;;
    "nuvola=play")
        nuvolaplayer-client toggle
        ;;
    "tomahawk=play")
        tomahawk --playpause
        ;;

    # PLAY/START
    "mopidy=start")
        ncmpcpp play
        ;;
    "spotify=start")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
           /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Play
        ;;
    "nuvola=start")
        nuvolaplayer-client play
        ;;
    "tomahawk=start")
        tomahawk --play
        ;;

    # PLAY/STOP
    "mopidy=stop")
        ncmpcpp pause
        ;;
    "spotify=stop")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
           /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Pause
        ;;
    "nuvola=stop")
        nuvolaplayer-client pause
        ;;
    "tomahawk=stop")
        tomahawk --stop
        ;;

    # NEXT
    "mopidy=next")
        ncmpcpp next
        ;;
    "spotify=next")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Next
        ;;
    "nuvola=next")
        nuvolaplayer-client next
        ;;
    "tomahawk=next")
        tomahawk --next
        ;;

    # PREV
    "mopidy=prev")
        ncmpcpp prev
        ;;
    "spotify=prev")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Previous
        ;;
    "nuvola=prev")
        nuvolaplayer-client prev
        ;;
    "tomahawk=prev")
        tomahawk --prev
        ;;

    # TITLE
    "mopidy=getTitle")
        ncmpcpp --now-playing %t
        ;;
    "spotify=getTitle")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
            string:'org.mpris.MediaPlayer2.Player' string:'Metadata' | \
            egrep -A 1 "title" | egrep -v "title" | cut -b 44- | \
            cut -d '"' -f 1 | egrep -v ^$
        ;;
    "nuvola=getTitle")
        nuvolaplayer-client status | grep '^Song' | cut -d\  -f2-
        ;;

    # ARTIST
    "mopidy=getArtist")
        ncmpcpp --now-playing %a
        ;;
    "spotify=getArtist")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
            string:'org.mpris.MediaPlayer2.Player' \
            string:'Metadata' | egrep -A 2 "artist" | egrep -v "artist" | \
            egrep -v "array"|cut -b 27-|cut -d '"' -f 1|egrep -v ^$
        ;;
    "nuvola=getArtist")
        nuvolaplayer-client status | grep '^Artist' | cut -d\  -f2-
        ;;

    # ALBUM
    "mopidy=getAlbum")
        ncmpcpp --now-playing %b
        ;;
    "spotify=getAlbum")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
            string:'org.mpris.MediaPlayer2.Player' string:'Metadata' | \
            egrep -A 2 "album" | egrep -v "album" | egrep -v "array" | \
            cut -b 44-|cut -d '"' -f 1|egrep -v ^$
        ;;
    "nuvola=getAlbum")
        nuvolaplayer-client status | grep '^Album' | cut -d\  -f2-
        ;;

    # STATUS
    "mopidy=getStatus")
        ncmpcpp --now-playing
        ;;
    "spotify=getStatus")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify \
            /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get \
            string:'org.mpris.MediaPlayer2.Player' string:'PlaybackStatus' | \
            grep 'string "[^"]*"'|sed 's/.*"\(.*\)"[^"]*$/\1/'
        ;;
    "nuvola=getStatus")
        nuvolaplayer-client status | grep '^Status' | cut -d\  -f2-
        ;;

    # No player and/or no action
    *)
        echo "$0 [start|stop|play|next|prev|getTitle|getArtist|getAlbum|getStatus]"
        ;;
esac

