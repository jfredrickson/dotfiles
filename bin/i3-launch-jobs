#!/bin/bash

# c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t
# vi: set shiftwidth=4 tabstop=4 noexpandtab:
# :indentSize=4:tabSize=4:noTabs=false:

set -o nounset
set -o errexit
set -o pipefail


# shellcheck disable=SC1090
source "$HOME/bin/common.bash"

# list of jobs to execute in screen
## filter comments and empty lines
JOBS=$(cat <<- EOF | sed -e 's/#.*//' -e '/^\s*$/d'
	mqtt-notify.py
	autocutsel -verbose -selection CLIPBOARD
	pulseaudio-dlna-d # 58080/tcp 65353/udp 1900/udp ALLOW IN
	setbg loop linux

	#rerandr3 daemon
	#autocutsel -verbose -selection PRIMARY
	#dbus-monitor interface=org.freedesktop.Notifications
EOF
)

function i3-launch-job() {
    if [ -z "$*" ]
    then
        notify_error "Nothing to launch"
        return
    fi
    notify "Checking for \"$*\" ... "
	if _pid=$(pgrep -f "$*" | xargs)
    then
		notify "              ... already running (${_pid})"
    else
        notify "              ... starting"
        # shellcheck disable=SC2048
		launch-screen i3jobs add $* | sed -e 's/^/ -   /'
    fi
}

# check if this is a fresh start, whether there's already an i3jobs screen
if (screen -list | grep -q i3jobs)
then
	PAUSE="0"
else
	# wait a bit more after the first job to allow screen to start up
	PAUSE="2"
fi

# launch the jobs
echo "$JOBS" | while read -r line
do
	# make sure we replace an existing setbg loop
	if [[ $line =~ "setbg loop" ]]
	then
		if _pid=$(pgrep -f "setbg loop")
		then
			kill -9 ${_pid}
			notify_debug "Killed existing setbg loop (${_pid})"
		fi
	fi
	i3-launch-job $line
	sleep $PAUSE
done

if ! pgrep -f "screen -D -r i3jobs" >/dev/null
then
	/usr/bin/terminator --role i3jobs --execute screen -D -r i3jobs
fi
