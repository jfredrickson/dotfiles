#!/bin/bash -e

[ "$1" = "do" ] || echo=echo

dotfiles=~/dotfiles/
cd ${dotfiles}

grepify() {
	echo -n " -e updatelinks "
	for pattern in $*
	do
		echo -n " -e $pattern "
	done
}

listfiles() {
	local base=${1}
	# -F option to force dirs ending in / for easy filtering
	# but we need to remove the @ for symlinks
	( cd ${dotfiles}${base}; ls -AF | sed s/@$// | grep -v ${grepv} )
}

updatelink() {
	local base=${1}
	local file=${2}

	[ -d ~/${base} ] || $echo mkdir -vp ~/${base}
	$echo ln -nvfs $( readlink -en ${dotfiles}${base}${file} ) $(readlink -en ~/${base} )/
}

updaterootlink() {
	local base=${1#ROOT/}
	local file=${2}

	[ -d /${base} ] || $echo mkdir -vp /${base}
	$echo sudo ln -nvfs $( readlink -en ${dotfiles}ROOT/${base}${file} ) $(readlink -en /${base} )/
}

updatefiles() {
	local base=${1}
	shift
	grepv="$(grepify $*)"
	local files=$( listfiles ${base} )
	local base2=${base#ROOT/}

	for file in ${files}
	do
		if [ $base = $base2 ]
		then
			updatelink ${base} ${file}
		else
			updaterootlink ${base} ${file}
		fi
	done
}


updatefiles ./ .config/ .local/ src/ var/ ROOT/
updatefiles .local/share/ applications
updatefiles .local/share/applications/
updatefiles .config/ gnome-session/
updatefiles .config/gnome-session/
for p in src/*/.git/
do
	updatefiles $p
done
updatefiles ROOT/usr/share/applications/
updatefiles ROOT/usr/share/unity-greeter/
updatefiles ROOT/usr/share/xsessions/

$echo sudo ln -nfs ~/dotfiles/ROOT/usr/share/gnome-session/sessions/awesome.session /usr/share/gnome-session/sessions/awesome.session
$echo sudo sed -i -e 's/^OnlyShowIn=GNOME;\(.*;\)*/OnlyShowIn=i3;Awesome;GNOME;\1/p' /etc/xdg/autostart/* /usr/share/applications/gnome*panel*
$echo sudo sed -i -e 's/^OnlyShowIn=Awesome;GNOME;\(.*;\)*/OnlyShowIn=i3;Awesome;GNOME;\1/p' /etc/xdg/autostart/* /usr/share/applications/gnome*panel*
$echo sudo ln -nfs /opt/google/chrome/libpdf.so /usr/lib/chromium-browser/
